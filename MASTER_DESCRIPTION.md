# Ultra Master Program Descriptor for LLM Ingestion

## 1. System Identity & Core Directive (`/ROOT`)

*   **System Name:** SENTINEL Defense System
*   **Version:** 1.0.34 (Production)
*   **Primary Directive:** To mitigate civilian risk in high-kinetic conflict zones by providing real-time, AI-verified intelligence, predictive forecasting, and evacuation logistics.
*   **Operational Philosophy:** "Safety over Speed." The system employs a **Human-In-The-Loop (HITL)** architecture where high-severity alerts (DEFCON 1-2) are artificially gated until human verification is received.

---

## 2. Architectural Topology

The system operates on a decentralized **Client-Server-Controller** topology.

### 2.1. The Intelligence Node (`/Server Backend`)
*   **Role:** The "Brain". Handles data ingestion, deductive reasoning, and state persistence.
*   **Tech Stack:** Python 3.9+, Django 4.1.13, MongoDB (Application Data), SQLite (Session Data).
*   **AI Engine:** Google Gemini 3 Pro (Reasoning), Gemini 2.5 Flash (Translation).
*   **Key Libraries:** `genai`, `shapely` (Geospatial), `feedparser` (OSINT), `pymongo`.

### 2.2. The Tactical Interface (`/Android Frontend`)
*   **Role:** The "Face". Visualizes threat vectors and provides navigation.
*   **Tech Stack:** Flutter (Dart), Provider (State Management), `flutter_map` (OpenStreetMap).
*   **Key Logic:** Ephemeral ID rotation (PDPA), Offline-First Architecture, Polling intervals (15s).

### 2.3. The Command Controller (`/Admin Console`)
*   **Role:** The "Gavel". Allows human override of AI decisions.
*   **Tech Stack:** Django Templates, HTMX, Bootstrap 5.
*   **Key Logic:** 2FA (TOTP) Authentication, Prompt Injection, Exclusion Zone Management.

---

## 3. Data Schema Registry (The DNA)

All modules must strictly adhere to these JSON schemas.

### 3.1. Master Intelligence Object (`IntelDetails`)
This object is generated by the Server and consumed by the Client.

```json
{
  "zip_code": "10110", // (String) Target Sector
  "country": "TH", // (String) ISO 2 Code
  "defcon_status": 3, // (Int) 1=War ... 5=Peace
  "is_certified": false, // (Bool) True ONLY if Admin POSTs approval
  "summary": [
    "ASSESSMENT: Artillery detected in Preah Vihear sector.", // AI Deductions
    "** ALERT: UNCONFIRMED RATING **" // System Warnings
  ],
  "tactical_overlays": [
    {
      "name": "Preah Vihear",
      "lat": 14.3914, "lon": 104.6804,
      "radius": 40000.0, // Meters
      "type": "Artillery", // Determines UI Color/Icon
      "last_kinetic": "2025-12-15"
    }
  ],
  "evacuation_point": {
    "name": "Bunker Alpha",
    "lat": 14.1, "lon": 103.5,
    "distance_km": 12.4,
    "reason": "Hardened Structure"
  },
  "predictive": {
    "forecast_summary": ["Expect escalation within 24h."],
    "forecast_trend": "Rising", // Enum: Rising, Stable, Falling
    "risk_probability": 85, // Int 0-100
    "defcon": 2 // Forecasted DEFCON
  },
  "sitrep_entries": [
    { "id": "a1b2", "topic": "Shelling", "summary": "...", "date": "..." }
  ],
  "forecast_entries": [
     { "topic": "Troop Movement", "prediction": "...", "rationale": "..." }
  ],
  "last_updated": "2026-01-13T12:00:00Z"
}
```

### 3.2. Exclusion Zone Object (Compliance)
Defined in `Thailand_Exclusary_Zones.csv` and loaded into Shapely.

```json
{
  "zone_name": "Royal Palace No-Fly",
  "risk_level": "HIGH",
  "shape_type": "CIRCLE", // or RECTANGLE
  "lat_center": 13.75,
  "lng_center": 100.50,
  "radius_km": 5.0
}
```

---

## 4. Module Logic Specification

### 4.1. Server Backend: The Conflict Agent (`scripts/conflict_agent.py`)
This script is the core intelligence loop.

1.  **Ingestion (`fetch_news`)**:
    *   Scrapes Google News RSS for kinetic keywords: `shelling | troop movement | artillery`.
    *   **Drift Filter**: MD5 hashes (Title + Link) are checked against `news_index`. Duplicate hashes update `last_seen` but are NOT passed to the AI.
2.  **Geospatial Resolution (`ZoneResolver`)**:
    *   Resolves Zip Code -> Lat/Lon via CSV lookup.
    *   Calculates `dist_km` to nearest rigid `HOTZONE` (defined in `geo_utils.py`) using Haversine formula.
3.  **The Compliance Gate (`core.compliance`)**:
    *   Input: User Lat/Lon.
    *   Action: Checks if point exists within any `Shapely` polygon defined in `Developer Inputs`.
    *   **Result**: If Inside -> **HARD BLOCK**. Returns "Restricted Zone" placeholder. No AI generation occurs.
4.  **AI Orchestration (`run_mission_logic`)**:
    *   Constructs Prompt: `Context (Zip/Dist) + News Text + System Prompt`.
    *   Invokes: `gemini-3-pro-preview`.
    *   **The Panic Filter**: If AI output `defcon <= 2`, system checks specific `is_certified` bit in DB. If false, **DOWNGRADE** status in UI (marked UNCONFIRMED) but preserve internal risk rating.
5.  **Persistence**:
    *   Saves final JSON to `intel_history` collection.
    *   Updates `system_status` for observability.

### 4.2. Android Frontend: The Watchman (`lib/main.dart`)
This is a `ChangeNotifier` state machine.

1.  **State Initialization (`determineServerUrl`)**:
    *   Pings `146.190.7.51/intel/status`.
    *   Success (200 OK) -> Sets `serverUrl` to VPS.
    *   Timeout/Error -> Sets `serverUrl` to `10.0.2.2:8000` (Android Emulator Localhost).
    *   This logic allows seamless transition between Dev and Prod without code changes.
2.  **Identity Rotation (`SentinelProvider`)**:
    *   Generates `UUIDv4`.
    *   Checks `IDCreatedDate` in SharedPreferences.
    *   If `Now - Created > 24h` -> **ROTATE ID**. (Privacy Compliance).
3.  **Visualization Logic (`DashboardPage`)**:
    *   **Rings**: `CustomPainter` draws expanding rings. Pulse rate derived from `(6 - defcon_status)`.
    *   **Map**: `FlutterMap` renders `CircleMarker` layers from `tactical_overlays` array.
    *   **Colors**: 
        *   Artillery/Conflict = `Colors.red.withOpacity(0.3)`
        *   Troop Movement = `Colors.yellow.withOpacity(0.3)`

### 4.3. Admin Console: The Actuator (`portal_views.py`)
1.  **Gatekeeper**: `is_staff` check + `TOTPDevice` (2FA) required for all write ops.
2.  **Override API (`api_decide_approval`)**:
    *   `POST /api/admin/approvals/decide`
    *   Accepts: `{ "zip_code": "...", "action": "APPROVE" }`
    *   Logic: Finds doc in `intel_history`, sets `is_certified = True`, sets `defcon = 1`.
3.  **Zone Injection**:
    *   Uploads CSV to `Developer Inputs/Thailand/`.
    *   `core.compliance` lazy-reloads this on next request.

---

## 5. Infrastructure & Deployment (`/Infrastructure`)

*   **Docker Compose (`docker-compose.prod.yml`)**:
    *   `web`: Django Gunicorn (Port 8000).
    *   `nginx`: Reverse Proxy (Port 80 -> 8000).
*   **Networking**:
    *   Nginx Config (`nginx.conf`) enables **Gzip Compression** (Level 6) to mitigate packet fragmentation on high-latency mobile networks.
*   **Data Volume**:
    *   `/data/db`: MongoDB persistence loop.

---

## 6. How to Build New Modules
To extend Sentinel, follow these integration rules:

1.  **Frontend Extensions**:
    *   Add new data fields to `IntelDetails.fromJson` in `main.dart`.
    *   Add corresponding UI widget in `DashboardPage`.
    *   **Constraint**: Must handle `null` values gracefully (Offline-First).
2.  **Backend Extensions**:
    *   Add logic to `conflict_agent.py`.
    *   Update `analyst_system_prompt.txt` to instruct AI on new fields.
    *   **Constraint**: NO new blocking calls. Use Threading for anything > 200ms.
3.  **New Country Support**:
    *   Add `CountryCode` folder in `Developer Inputs`.
    *   Add `_Exclusary_Zones.csv`.
    *   Update `COUNTRY_MAP` in `core/compliance.py`.

---
*End of Ultra Master Descriptor. System State: Canonical.*
